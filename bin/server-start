#!/bin/bash

# Check if wp-cli and ngrok are available or not.
if ! which wp > /dev/null; then
    echo "wp-cli is not installed. Please install it first."
    exit
fi

if ! which ngrok > /dev/null; then
    echo "ngrok is not installed. Please install it first."
    exit
fi

# Create a wordpress directory where we can build the WordPress setup.
mkdir -p wordpress

# Change the current directory to our wordpress directory.
cd wordpress

# Launch the web server
# wp server > /dev/null 2>&1 & # Not working. Need to check again.
php -S localhost:8080 > /dev/null 2>&1 &

# Launch ngrok to expose the localhost port to the internet.
ngrok http 8080 > /dev/null 2>&1 &

function getPublicUrl() {
    echo $(curl http://localhost:4040/api/tunnels -s | grep -oP '(?<="public_url":")https[^"]*')
}

publicUrl=$(getPublicUrl)

while [ -z "$publicUrl" ]; do
    sleep 1
    publicUrl=$(getPublicUrl)
done

# Create a WordPress site.
dbname="px_toolbox_php"
dbuser="root"
dbpass="root"
dbhost="localhost"

FILE=wp-content
if [ ! -d "$FILE" ]; then
    wp core download
    wp core config --dbname=$dbname --dbuser=$dbuser --dbpass=$dbpass --dbhost=$dbhost --extra-php <<PHP
\$_SERVER['HTTPS']='on';
PHP
    wp db create
    wp core install --url=$publicUrl --title="WordPress" --admin_user=admin --admin_password=password --admin_email="admin@example.com" --skip-email

    # This is required for the .htaccess.
    touch wp-cli.local.yml
    echo "apache_modules:
      - mod_rewrite
    " > wp-cli.local.yml

    # Set pretty urls.
    wp rewrite structure '/%postname%/' --hard
    wp rewrite flush --hard

    rm wp-cli.local.yml

    wp post create ../bin/posts/one.html --post_name=lorem-ipsum --post_title='Lorem Ipsum' --post_status=publish --post_author=1
    wp post create ../bin/posts/two.html --post_name=servari-enim --post_title='Servari Enim' --post_status=publish --post_author=1
fi

echo $publicUrl
